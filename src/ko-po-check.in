#! /usr/bin/env python

import sys,os,getopt

moduledir = "@prefix@/share/ko-po-check"
VERSION = "@VERSION@"

def help():
    helpmsg = ["Usage: ko-po-check [옵션]... [파일]...<\n",
               "      --help                이 도움말을 보여주고 종료합니다\n",
               "      --version             버전 정보를 표시하고 종료합니다\n"]
    sys.stdout.writelines(helpmsg)
    sys.exit(1)

def version():
    versionmsg = ["ko-po-check %s\n" % VERSION]
    sys.stdout.writelines(versionmsg)
    sys.exit(0)
    

# processing the command line options

try:
    options, args = getopt.getopt(sys.argv[1:], "",
                                  ['help', 'version', 'moduledir='])
except getopt.GetoptError, msg:
    print "%s: %s" % (os.path.basename(sys.argv[0]), msg)
    sys.exit(1)

for (opt, val) in options:
    if opt == '--help':
        help()
    elif opt == '--version':
        version()
    elif opt == '--moduledir':
        moduledir = val
    
filtersdir = moduledir + "/filters"

sys.path.append(moduledir)

import po,poparse,codecs

if args:
    fn = args[0]
else:
    fn = '-'

if fn == '-':
    fp = sys.stdin
else:
    fp = open(fn)

# codec install check
try:
    codecs.lookup('euc-kr')
except LookupError:
    sys.stderr.write("euc-kr codec이 설치되지 않았습니다.  http://koco.sourceforge.net\n")
    sys.exit(1)

catalog = poparse.parse_file(fp)

import string,re
import glob

# FIXME -- 일단 EUC-KR로 전부 바꾼다

# content_type = catalog.metadata['Content-Type']
# charset = string.lower(content_type[string.find(content_type, 'charset=')+len('charset='):])
# if charset != 'euc-kr':
#     import codecs
#     for entry in catalog.entries:
#         try:
#             entry.msgstr = unicode(entry.msgstr, charset).encode('euc-kr')
#             entry.translator_comment = unicode(entry.translator_comment, charset).encode('euc-kr')
#         except:
#             print "err:%d"%entry.msgstr_lineno

#

filenames = glob.glob(filtersdir+"/*.py")
filters = {}
for filename in filenames:
    f = {}
    execfile(filename, f)
    filters[f['name']] = f

for entry in catalog.entries:
#    print entry.msgstr.encode('euc-kr')
    for filtername in filters.keys():
        t,e = filters[filtername]['check'](entry.msgid, entry.msgstr)
        if not t:
            for line in string.split(e,'\n'):
                print "%s:%d: %s" % (fn,entry.msgstr_lineno,unicode(line, 'utf-8').encode('euc-kr'))
