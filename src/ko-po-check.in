#! /usr/bin/env python

import os,sys

moduledir = "@prefix@/share/ko-po-check"
filtersdir = moduledir + "/filters"

sys.path.append(moduledir)

import po,poparse

if sys.argv[1:]:
    fn = sys.argv[1]
else:
    fn = '-'

if fn == '-':
    fp = sys.stdin
else:
    fp = open(fn)

catalog = poparse.parse_file(fp)

import string,re
import glob

# FIXME -- 일단 EUC-KR로 전부 바꾼다

content_type = catalog.metadata['Content-Type']
charset = string.lower(content_type[string.find(content_type, 'charset=')+len('charset='):])
if charset != 'euc-kr':
    import codecs
    for entries in catalog.entries:
        entries.msgstr = unicode(entries.msgstr, charset).encode('euc-kr')
        entries.translator_comment = unicode(entries.translator_comment, charset).encode('euc-kr')
        

filenames = glob.glob(filtersdir+"/*.py")
filters = {}
for filename in filenames:
    f = {}
    execfile(filename, f)
    filters[f['name']] = f

for entry in catalog.entries:
    for filtername in filters.keys():
        t,e = filters[filtername]['check'](entry.msgid, entry.msgstr)
        if not t:
            print "%s:%d: %s" % (fn,entry.msgstr_lineno,e)
